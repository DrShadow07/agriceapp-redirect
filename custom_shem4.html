<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ouvrir AgriceApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const SECRET_KEY = "MaCleSuperSecrete123"; // ‚ö†Ô∏è M√™me cl√© que dans le g√©n√©rateur

        function openApp() {
            const urlParams = new URLSearchParams(window.location.search);
            let appUrl = "dimsapp://open";

            if (urlParams.has("data")) {
                // --- D√©chiffrer ---
                try {
                    const encrypted = urlParams.get("data");
                    const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
                    const decryptedText = bytes.toString(CryptoJS.enc.Utf8);

                    if (!decryptedText) {
                        console.error("‚ö†Ô∏è Impossible de d√©chiffrer les donn√©es !");
                    } else {
                        const data = JSON.parse(decryptedText);

                        // Construire l‚ÄôURL avec les param√®tres d√©chiffr√©s
                        const query = new URLSearchParams(data).toString();
                        appUrl += "?" + query;
                    }
                } catch (e) {
                    console.error("Erreur d√©cryptage:", e);
                }
            } else {
                // Pas de cryptage, passer les param√®tres tels quels
                if (urlParams.toString()) {
                    appUrl += "?" + urlParams.toString();
                }
            }

            console.log("Ouverture de l‚Äôapp avec URL:", appUrl);

            // Tenter d‚Äôouvrir l‚Äôapp
            window.location.href = appUrl;

            // Rediriger vers Play Store si l‚Äôapp n‚Äôest pas install√©e
            setTimeout(function () {
                window.location.href = "https://play.google.com/store/apps/details?id=ci.directsoft.agriceapp";
            }, 1500);
        }

        // Ex√©cution automatique au chargement
        window.onload = openApp;
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f0f8ff;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 25px;
            text-decoration: none;
            border-radius: 5px;
            display: inline-block;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîó Ouverture de AgriceApp...</h1>
    <p>Redirection automatique en cours</p>

    <p>Si l'application ne s'ouvre pas automatiquement :</p>
    <a href="#" onclick="openApp(); return false;" class="button">Cliquez ici pour ouvrir l'app</a>

    <br><br>
    <small>Si l'application n'est pas install√©e, vous serez redirig√© vers le Play Store</small>

    <script>
        // Debug: afficher les param√®tres re√ßus
        const urlParams = new URLSearchParams(window.location.search);
        console.log("Param√®tres re√ßus bruts:", Array.from(urlParams.entries()));
    </script>
</body>
</html>
